#!/opt/pwn.college/bash
set -e

# 1) Shim python in /challenge/bin so pip & python work
mkdir -p /challenge/bin \
  && ln -sf /usr/bin/python3 /usr/bin/python /challenge/bin
export PATH=/challenge/bin:$PATH

# 2) Install system deps (MySQL client + server)
apt-get update \
  && apt-get install -y default-libmysqlclient-dev mysql-server \
  && rm -rf /var/lib/apt/lists/*

# 3) Install Python deps
pip install -r /challenge/simple-webapp/requirements.txt

# 4) Start MySQL and bootstrap the DB
service mysql start
mysql -e "CREATE DATABASE webapp;
           CREATE USER 'user'@'localhost' IDENTIFIED BY 'pass';
           GRANT ALL ON webapp.* TO 'user'@'localhost';
           FLUSH PRIVILEGES;"
